<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MD Viewer</title>
    <!-- Marked.js for Markdown -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Mermaid.js for diagrams -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <!-- Highlight.js for code -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/python.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #0d1117;
            color: #c9d1d9;
            min-height: 100vh;
        }

        /* Header */
        .header {
            padding: 16px 24px;
            border-bottom: 1px solid #30363d;
            background: #161b22;
            display: flex;
            align-items: center;
            gap: 16px;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header h1 {
            font-size: 18px;
            font-weight: 600;
            color: #58a6ff;
        }

        .file-input-wrapper {
            position: relative;
        }

        .file-input {
            display: none;
        }

        .btn {
            padding: 8px 16px;
            border-radius: 6px;
            border: 1px solid #30363d;
            background: #21262d;
            color: #c9d1d9;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }

        .btn:hover {
            background: #30363d;
            border-color: #8b949e;
        }

        .btn-primary {
            background: #238636;
            border-color: #238636;
        }

        .btn-primary:hover {
            background: #2ea043;
        }

        .file-name-display {
            font-size: 14px;
            color: #8b949e;
            margin-left: auto;
        }

        /* Content */
        .content {
            max-width: 900px;
            margin: 0 auto;
            padding: 32px 24px;
        }

        /* Welcome */
        .welcome {
            text-align: center;
            padding: 100px 20px;
            color: #8b949e;
        }

        .welcome h2 {
            font-size: 28px;
            margin-bottom: 16px;
            color: #c9d1d9;
        }

        .welcome p {
            margin-bottom: 12px;
            font-size: 16px;
        }

        .welcome .hint {
            margin-top: 32px;
            padding: 16px;
            background: #161b22;
            border-radius: 6px;
            border: 1px solid #30363d;
        }

        .welcome code {
            background: #21262d;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 14px;
        }

        /* Markdown Styles */
        .markdown-body {
            line-height: 1.7;
        }

        .markdown-body h1 {
            font-size: 2em;
            border-bottom: 1px solid #30363d;
            padding-bottom: 0.3em;
            margin-bottom: 16px;
            margin-top: 24px;
        }

        .markdown-body h1:first-child {
            margin-top: 0;
        }

        .markdown-body h2 {
            font-size: 1.5em;
            border-bottom: 1px solid #30363d;
            padding-bottom: 0.3em;
            margin-top: 24px;
            margin-bottom: 16px;
        }

        .markdown-body h3 {
            font-size: 1.25em;
            margin-top: 24px;
            margin-bottom: 16px;
        }

        .markdown-body h4 {
            font-size: 1em;
            margin-top: 24px;
            margin-bottom: 16px;
        }

        .markdown-body p {
            margin-bottom: 16px;
        }

        .markdown-body code {
            background: #161b22;
            padding: 0.2em 0.4em;
            border-radius: 6px;
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
            font-size: 85%;
        }

        .markdown-body pre {
            background: #161b22;
            padding: 16px;
            border-radius: 6px;
            overflow-x: auto;
            margin-bottom: 16px;
            border: 1px solid #30363d;
        }

        .markdown-body pre code {
            background: transparent;
            padding: 0;
            font-size: 13px;
            line-height: 1.5;
        }

        .markdown-body ul, .markdown-body ol {
            padding-left: 2em;
            margin-bottom: 16px;
        }

        .markdown-body li {
            margin-bottom: 4px;
        }

        .markdown-body blockquote {
            border-left: 4px solid #30363d;
            padding-left: 16px;
            color: #8b949e;
            margin-bottom: 16px;
        }

        .markdown-body table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 16px;
            display: block;
            overflow-x: auto;
        }

        .markdown-body th, .markdown-body td {
            border: 1px solid #30363d;
            padding: 8px 12px;
            text-align: left;
        }

        .markdown-body th {
            background: #161b22;
            font-weight: 600;
        }

        .markdown-body a {
            color: #58a6ff;
            text-decoration: none;
        }

        .markdown-body a:hover {
            text-decoration: underline;
        }

        .markdown-body hr {
            border: none;
            border-top: 1px solid #30363d;
            margin: 24px 0;
        }

        .markdown-body strong {
            font-weight: 600;
        }

        .markdown-body img {
            max-width: 100%;
            border-radius: 6px;
        }

        /* Mermaid */
        .mermaid {
            background: #161b22;
            padding: 20px;
            border-radius: 6px;
            margin-bottom: 16px;
            text-align: center;
            border: 1px solid #30363d;
        }

        .mermaid svg {
            max-width: 100%;
        }

        /* TOC */
        .toc-container {
            position: fixed;
            right: 24px;
            top: 100px;
            width: 220px;
            max-height: calc(100vh - 150px);
            overflow-y: auto;
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 12px;
            font-size: 12px;
            display: none;
        }

        .toc-container.visible {
            display: block;
        }

        .toc-title {
            font-weight: 600;
            margin-bottom: 12px;
            color: #8b949e;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .toc-item {
            display: block;
            padding: 4px 0;
            color: #8b949e;
            text-decoration: none;
            cursor: pointer;
            border-radius: 4px;
            transition: color 0.2s;
        }

        .toc-item:hover {
            color: #58a6ff;
        }

        .toc-h2 { padding-left: 0; font-weight: 500; }
        .toc-h3 { padding-left: 12px; }
        .toc-h4 { padding-left: 24px; font-size: 11px; }

        /* Drag & Drop */
        .drop-zone {
            border: 2px dashed #30363d;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            margin-top: 24px;
            transition: all 0.2s;
        }

        .drop-zone.drag-over {
            border-color: #58a6ff;
            background: #161b22;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #0d1117;
        }

        ::-webkit-scrollbar-thumb {
            background: #30363d;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #484f58;
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .toc-container {
                display: none !important;
            }
        }

        @media (max-width: 768px) {
            .content {
                padding: 16px;
            }

            .header {
                flex-wrap: wrap;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>MD Viewer</h1>
        <div class="file-input-wrapper">
            <input type="file" id="fileInput" class="file-input" accept=".md,.markdown" multiple>
            <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
                Open File
            </button>
        </div>
        <button class="btn" id="tocBtn" onclick="toggleToc()" style="display:none;">TOC</button>
        <span class="file-name-display" id="fileNameDisplay"></span>
    </div>

    <div class="content" id="content">
        <div class="welcome">
            <h2>MD Viewer</h2>
            <p>Markdown 파일을 Mermaid 다이어그램과 함께 볼 수 있습니다</p>
            <p>위의 <strong>Open File</strong> 버튼을 클릭하거나 파일을 드래그 앤 드롭하세요</p>

            <div class="drop-zone" id="dropZone">
                <p>MD 파일을 여기에 드롭하세요</p>
            </div>

            <div class="hint">
                <p>지원하는 파일 경로 예시:</p>
                <code>/nas/home/qmdlghfl3/home/2026/Bagel/BAGEL_Inference_Flow.md</code>
            </div>
        </div>
    </div>

    <div class="toc-container" id="toc">
        <div class="toc-title">Table of Contents</div>
        <div id="tocContent"></div>
    </div>

    <script>
        // Initialize Mermaid
        mermaid.initialize({
            startOnLoad: false,
            theme: 'dark',
            themeVariables: {
                darkMode: true,
                background: '#161b22',
                primaryColor: '#238636',
                primaryTextColor: '#c9d1d9',
                primaryBorderColor: '#30363d',
                lineColor: '#8b949e',
                secondaryColor: '#21262d',
                tertiaryColor: '#161b22',
                fontFamily: '-apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Helvetica Neue, Arial, sans-serif'
            },
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true,
                curve: 'basis'
            }
        });

        // Configure Marked
        marked.setOptions({
            highlight: function(code, lang) {
                if (lang && hljs.getLanguage(lang)) {
                    return hljs.highlight(code, { language: lang }).value;
                }
                return hljs.highlightAuto(code).value;
            },
            breaks: true,
            gfm: true
        });

        // File input handler
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                readFile(file);
            }
        });

        // Drag & Drop
        const dropZone = document.getElementById('dropZone');
        const body = document.body;

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            body.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            body.addEventListener(eventName, () => {
                if (dropZone) dropZone.classList.add('drag-over');
            }, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            body.addEventListener(eventName, () => {
                if (dropZone) dropZone.classList.remove('drag-over');
            }, false);
        });

        body.addEventListener('drop', function(e) {
            const file = e.dataTransfer.files[0];
            if (file && (file.name.endsWith('.md') || file.name.endsWith('.markdown'))) {
                readFile(file);
            }
        }, false);

        // Read file
        function readFile(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                renderMarkdown(e.target.result, file.name);
            };
            reader.readAsText(file);
        }

        // Render markdown
        function renderMarkdown(content, filename) {
            document.getElementById('fileNameDisplay').textContent = filename;
            document.getElementById('tocBtn').style.display = 'inline-block';

            // Render markdown
            const html = marked.parse(content);
            document.getElementById('content').innerHTML = `<div class="markdown-body">${html}</div>`;

            // Process Mermaid diagrams
            const mermaidBlocks = document.querySelectorAll('pre code.language-mermaid');
            mermaidBlocks.forEach((block, index) => {
                const container = document.createElement('div');
                container.className = 'mermaid';
                container.id = `mermaid-${index}`;
                container.textContent = block.textContent;
                block.parentElement.replaceWith(container);
            });

            // Render Mermaid with error handling
            try {
                mermaid.run({
                    querySelector: '.mermaid'
                });
            } catch (err) {
                console.error('Mermaid rendering error:', err);
            }

            // Build TOC
            buildToc();

            // Scroll to top
            window.scrollTo(0, 0);
        }

        // Build table of contents
        function buildToc() {
            const headings = document.querySelectorAll('.markdown-body h2, .markdown-body h3, .markdown-body h4');
            let tocHtml = '';

            headings.forEach((heading, index) => {
                const id = `heading-${index}`;
                heading.id = id;
                const level = heading.tagName.toLowerCase();
                const text = heading.textContent.length > 40
                    ? heading.textContent.substring(0, 40) + '...'
                    : heading.textContent;
                tocHtml += `<a class="toc-item toc-${level}" onclick="scrollToHeading('${id}')">${text}</a>`;
            });

            document.getElementById('tocContent').innerHTML = tocHtml;
        }

        function scrollToHeading(id) {
            const element = document.getElementById(id);
            if (element) {
                element.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        function toggleToc() {
            const toc = document.getElementById('toc');
            toc.classList.toggle('visible');
        }

        // Keyboard shortcut: Ctrl+O to open file
        document.addEventListener('keydown', function(e) {
            if ((e.ctrlKey || e.metaKey) && e.key === 'o') {
                e.preventDefault();
                document.getElementById('fileInput').click();
            }
        });
    </script>
</body>
</html>
